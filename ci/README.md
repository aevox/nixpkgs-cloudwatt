### Build and Use the Hydra container

First build the Hydra Docker image (from the `nixpkgs-cloudwatt` directory)
```
$ nix-build -A ci.hydra
```

The link `result` points to the image which can be loaded by Docker
```
$ docker load < ./result
```

Hydra needs `PostgreSQL` as database backend. So first run it with Docker
```
$ docker run --name postgres -d postgres:9.3
```

We then have to initialize the database and hydra

```
docker exec postgres su postgres -c "createuser hydra"
docker exec postgres su postgres -c "createdb -O hydra hydra"
```

Note, if you choose different credentials, you have to set the
HYDRA_DBI environment variable as explained below.

We can then start the Hydra container
```
$ docker run --name hydra -d -p 3000:3000 --link postgres:postgres
```

We can then access the webUI at `http://localhost:3000`. To create an
admin account, we can either use the `hydra-create-user` command or
set container environment variables `HYDRA_ADMIN_*` as explained below.


### Creating a project and a jobset

The script `create-jobset.sh` can be used to create a jobset to build
expressions defined in the current repository. To set the hydra url,
user credentials, set environment variables:
```
$ URL=YOUR-HYDRA USERNAME=admin PASSWORD=admin bash ci/create-project.sh
```


### Binary cache

The container can take the environment variable `BINARY_CACHE_KEY_SECRET`
that should contain the secret used to sign the binary cache.

To generate this secret:
```
nix-store --generate-binary-cache-key hydra hydra.secret hydra.public
```

Then, run the container with
```
docker run -e "BINARY_CACHE_KEY_SECRET=$(cat hydra.secret)" hydra
```

If we want to use this generated signed binary cache to speed up first Hydra
evaluation, you have to provide the environment variable
`BINARY_CACHE_KEY_SECRET`.

Note: if you don't provide this environment variable, binary caches
      don't need to be signed (nix.conf `signed-binary-caches` variable is not set).


### Specifying databases credentials

```
docker run -e "HYDRA_DBI=dbi:Pg:dbname=hydra;host=postgres;user=hydra;" -e POSTGRES_PASSWORD=my-password hydra
```

### Set the number of parallel jobs

The `MAX_JOBS` environment variable define how many jobs can be run in
parallel. By default, it is set to `1`.

```
docker run -e "MAX_JOBS=12" hydra
```


### Create the Hydra admin account at startup

If environment variables `HYDRA_ADMIN_USERNAME` and `HYDRA_ADMIN_PASSWORD`
are both set, they are then used to create an account with the `admin` role.

```
docker run -p 3000:3000 --link postgres:postgres -e HYDRA_ADMIN_USERNAME=hydraAdmin -e HYDRA_ADMIN_PASSWORD=hydraPwd hydra
```


### Volumes or Stateful datas

There are currently two directories that are stateful

- `/hydra` which contains the build logs and the hydra gcroots (this
  is used to specify elements that must not be garbage collected)
- `/nix-cache` which contains the nix cache. This is currently used
  when the container restart.


### Issues

- If the provided number of concurrent jobs (`MAX_JOBS`) is not
  applied, try to restart the hydra-queue-runner.
  This is maybe the this process started before the nix file was
  generated by the hydra-web-server unit.
